{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Left Sidebar - Suggestions -->
        <div class="col-lg-3 d-none d-lg-block">
            <div class="glass-card sticky-top" style="top: 20px;">
                <h5 class="mb-3">Suggested for you</h5>
                {% for suggestion in suggested_users %}
                <div class="d-flex align-items-center mb-3">
                    <div class="profile-avatar me-2" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2);">
                        {% if suggestion.activity.profile_picture %}
                            <img src="{{ suggestion.activity.profile_picture.url }}" alt="{{ suggestion.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <span style="color: white; font-weight: 600; line-height: 40px;">{{ suggestion.username|first|upper }}</span>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <strong>{{ suggestion.username }}</strong>
                        <small class="text-muted d-block">{{ suggestion.activity.follower_count }} followers</small>
                    </div>
                    <button class="btn btn-sm btn-create follow-suggestion-btn" data-username="{{ suggestion.username }}">Follow</button>
                </div>
                {% empty %}
                <p class="text-muted">No suggestions yet</p>
                {% endfor %}
            </div>
        </div>

        <!-- Main Feed -->
        <div class="col-lg-6">
            <!-- Create Post Card -->
            {% if user.is_authenticated %}
            <div class="glass-card mb-4">
                <div class="d-flex align-items-center">
                    <div class="profile-avatar me-3" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2);">
                        {% if user.activity.profile_picture %}
                            <img src="{{ user.activity.profile_picture.url }}" alt="{{ user.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <span style="color: white; font-weight: 700; line-height: 50px;">{{ user.username|first|upper }}</span>
                        {% endif %}
                    </div>
                    <a href="{% url 'create_post' %}" class="flex-grow-1 text-decoration-none">
                        <div class="create-post-placeholder" style="background: rgba(0,0,0,0.05); border-radius: 50px; padding: 15px 20px; color: #666;">
                            What's on your mind, {{ user.username }}?
                        </div>
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- New Posts Alert -->
            {% if new_posts_count > 0 %}
                <div class="new-posts-alert text-center mb-3">
                    <button class="btn btn-create" onclick="loadNewPosts()">
                        <i class="fas fa-arrow-up me-2"></i>{{ new_posts_count }} new post{{ new_posts_count|pluralize }}
                    </button>
                </div>
            {% endif %}

            <!-- Posts Container -->
            <div id="posts-container">
                {% for post in posts %}
                    {% include 'posts/_post_card.html' with post=post user_reaction=post.get_user_reaction user_saved=post.save_count > 0 %}
                {% empty %}
                    <div class="glass-card text-center py-5">
                        <i class="fas fa-smile-wink fa-4x mb-3" style="color: #667eea;"></i>
                        <h3>No posts yet!</h3>
                        <p class="text-muted">Be the first to share something with the community!</p>
                        {% if user.is_authenticated %}
                            <a href="{% url 'create_post' %}" class="btn-create mt-3">Create Post</a>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <!-- End of Feed -->
            <div id="end-of-feed" class="text-center py-4 text-muted" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>You're all caught up!
            </div>
        </div>

        <!-- Right Sidebar - Trending -->
        <div class="col-lg-3 d-none d-lg-block">
            <div class="glass-card sticky-top" style="top: 20px;">
                <h5 class="mb-3">Trending</h5>
                {% for trending in trending_posts %}
                <a href="{% url 'post_detail' trending.id %}" class="text-decoration-none">
                    <div class="mb-3 p-2" style="background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <strong>{{ trending.title|truncatechars:30 }}</strong>
                        <small class="text-muted d-block">{{ trending.reaction_count }} reactions</small>
                    </div>
                </a>
                {% empty %}
                <p class="text-muted">No trending posts yet</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body text-center">
                <img src="" id="modalImage" class="img-fluid" style="max-height: 90vh;">
            </div>
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
        </div>
    </div>
</div>

<script>
// ==================== INFINITE SCROLL ====================
let currentPage = 2;
let loading = false;
let hasNext = {% if posts.has_next %}true{% else %}false{% endif %};

window.addEventListener('scroll', function() {
    if (loading || !hasNext) return;
    
    const scrollPosition = window.innerHeight + window.scrollY;
    const documentHeight = document.documentElement.scrollHeight;
    
    if (scrollPosition >= documentHeight - 500) {
        loadMorePosts();
    }
});

function loadMorePosts() {
    loading = true;
    document.getElementById('loading-spinner').style.display = 'block';
    
    fetch(`/load-more/?page=${currentPage}`)
        .then(response => response.json())
        .then(data => {
            if (data.posts_html) {
                document.getElementById('posts-container').insertAdjacentHTML('beforeend', data.posts_html);
                currentPage = data.next_page;
                hasNext = data.has_next;
                
                if (!hasNext) {
                    document.getElementById('end-of-feed').style.display = 'block';
                }
            }
        })
        .finally(() => {
            loading = false;
            document.getElementById('loading-spinner').style.display = 'none';
        });
}

// ==================== REACTIONS ====================
document.addEventListener('click', function(e) {
    const reactionBtn = e.target.closest('.reaction-btn[data-reaction]');
    if (!reactionBtn) return;
    
    e.preventDefault();
    
    const postId = reactionBtn.dataset.postId;
    const reactionType = reactionBtn.dataset.reaction;
    const postCard = reactionBtn.closest('.post-card');
    
    fetch(`/ajax/react/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ reaction_type: reactionType })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update all reaction counts
            for (const [reaction, count] of Object.entries(data.counts)) {
                const countElement = postCard.querySelector(`.${reaction}-count`);
                if (countElement) {
                    countElement.textContent = count;
                }
            }
            
            // Update active state
            postCard.querySelectorAll('.reaction-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (data.user_reaction) {
                reactionBtn.classList.add('active');
            }
            
            // Update total reactions
            const totalReactions = Object.values(data.counts).reduce((a, b) => a + b, 0);
            postCard.querySelector('.reactions-count').textContent = totalReactions;
            
            // Visual feedback
            reactionBtn.style.transform = 'scale(1.2)';
            setTimeout(() => reactionBtn.style.transform = 'scale(1)', 200);
        }
    });
});

// ==================== TOGGLE COMMENTS ====================
document.addEventListener('click', function(e) {
    const toggleBtn = e.target.closest('.comment-toggle-btn');
    if (!toggleBtn) return;
    
    e.preventDefault();
    
    const postId = toggleBtn.dataset.postId;
    const commentsSection = document.querySelector(`.comments-section-${postId}`);
    
    if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
    } else {
        commentsSection.style.display = 'none';
    }
});

// ==================== ADD COMMENT ====================
document.addEventListener('click', function(e) {
    const submitBtn = e.target.closest('.submit-comment-btn');
    if (!submitBtn) return;
    
    e.preventDefault();
    
    const postId = submitBtn.dataset.postId;
    const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
    const content = input.value.trim();
    
    if (!content) return;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    fetch(`/ajax/comment/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const commentsContainer = document.querySelector(`.comments-container-${postId}`);
            commentsContainer.insertAdjacentHTML('afterbegin', data.comment_html);
            input.value = '';
            
            // Update comment count
            const commentCount = document.querySelector(`.comment-toggle-btn[data-post-id="${postId}"] .comments-count`);
            if (commentCount) {
                commentCount.textContent = parseInt(commentCount.textContent) + 1;
            }
        }
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Post';
    });
});

// ==================== LIKE COMMENT ====================
document.addEventListener('click', function(e) {
    const likeBtn = e.target.closest('.comment-like-btn');
    if (!likeBtn) return;
    
    e.preventDefault();
    
    const commentId = likeBtn.dataset.commentId;
    const countSpan = likeBtn.querySelector('.comment-like-count');
    
    fetch(`/ajax/comment/${commentId}/react/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.action === 'added') {
                likeBtn.classList.add('active');
            } else {
                likeBtn.classList.remove('active');
            }
            countSpan.textContent = data.reaction_count;
        }
    });
});

// ==================== SAVE POST ====================
document.addEventListener('click', function(e) {
    const saveBtn = e.target.closest('.save-btn');
    if (!saveBtn) return;
    
    e.preventDefault();
    
    const postId = saveBtn.dataset.postId;
    const countSpan = document.querySelector(`.post-card[data-post-id="${postId}"] .saves-count`);
    
    fetch(`/ajax/post/${postId}/save/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_saved) {
                saveBtn.classList.add('active');
            } else {
                saveBtn.classList.remove('active');
            }
            if (countSpan) {
                countSpan.textContent = data.save_count;
            }
        }
    });
});

// ==================== SHARE POST ====================
document.addEventListener('click', function(e) {
    const shareBtn = e.target.closest('.share-btn');
    if (!shareBtn) return;
    
    e.preventDefault();
    
    const postId = shareBtn.dataset.postId;
    const countSpan = document.querySelector(`.post-card[data-post-id="${postId}"] .shares-count`);
    
    fetch(`/ajax/post/${postId}/share/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && countSpan) {
            countSpan.textContent = data.share_count;
            
            // Show share success message
            shareBtn.insertAdjacentHTML('afterend', 
                '<div class="share-toast">Link copied to clipboard!</div>');
            setTimeout(() => document.querySelector('.share-toast')?.remove(), 2000);
        }
    });
});

// ==================== REPORT POST ====================
document.addEventListener('click', function(e) {
    const reportBtn = e.target.closest('.submit-report-btn');
    if (!reportBtn) return;
    
    e.preventDefault();
    
    const postId = reportBtn.dataset.postId;
    const reason = document.querySelector(`.report-reason[data-post-id="${postId}"]`).value;
    const description = document.querySelector(`.report-description[data-post-id="${postId}"]`).value;
    
    fetch(`/ajax/post/${postId}/report/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ reason: reason, description: description })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(`reportModal-${postId}`));
            modal.hide();
            
            // Show success message
            alert('Report submitted successfully. Thank you for keeping our community safe!');
        }
    });
});

// ==================== FOLLOW USER ====================
document.addEventListener('click', function(e) {
    const followBtn = e.target.closest('.follow-suggestion-btn');
    if (!followBtn) return;
    
    e.preventDefault();
    
    const username = followBtn.dataset.username;
    
    fetch(`/profile/${username}/follow/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_following) {
                followBtn.textContent = 'Following';
                followBtn.classList.add('active');
            } else {
                followBtn.textContent = 'Follow';
                followBtn.classList.remove('active');
            }
        }
    });
});

// ==================== IMAGE MODAL ====================
function openImageModal(imageUrl) {
    document.getElementById('modalImage').src = imageUrl;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// ==================== LOAD NEW POSTS ====================
function loadNewPosts() {
    location.reload();
}

// ==================== VIEW ALL COMMENTS ====================
document.addEventListener('click', function(e) {
    const viewAllBtn = e.target.closest('.view-all-comments');
    if (!viewAllBtn) return;
    
    e.preventDefault();
    
    const postId = viewAllBtn.dataset.postId;
    window.location.href = `/post/${postId}/`;
});

// ==================== DELETE COMMENT ====================
document.addEventListener('click', function(e) {
    const deleteBtn = e.target.closest('.delete-comment-btn');
    if (!deleteBtn) return;
    
    e.preventDefault();
    
    if (!confirm('Are you sure you want to delete this comment?')) return;
    
    const commentId = deleteBtn.dataset.commentId;
    const commentElement = document.getElementById(`comment-${commentId}`);
    
    fetch(`/ajax/comment/${commentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            commentElement.remove();
        }
    });
});
</script>

<style>
.reaction-btn.active {
    color: var(--neon-purple) !important;
    font-weight: 600;
}

.save-btn.active {
    color: #ffd700 !important;
}

.comment-like-btn.active {
    color: var(--neon-purple) !important;
}

.share-toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    padding: 10px 20px;
    border-radius: 50px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 9999;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translate(-50%, 20px);
    }
    to {
        opacity: 1;
        transform: translate(-50%, 0);
    }
}

.create-post-placeholder:hover {
    background: rgba(0,0,0,0.08) !important;
    transition: all 0.3s;
}

.new-posts-alert {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}