{% load static %}

<div class="comment mb-2" id="comment-{{ comment.id }}" style="margin-left: {% if comment.parent %}30px{% else %}0{% endif %};">
    <div class="d-flex">
        <div class="profile-avatar me-2" style="width: 28px; height: 28px; font-size: 0.8rem;">
            {% if comment.author.activity.profile_picture %}
                <img src="{{ comment.author.activity.profile_picture.url }}" style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
                {{ comment.author.username|first|upper }}
            {% endif %}
        </div>
        <div class="flex-grow-1">
            <div class="d-flex align-items-center gap-2 mb-1">
                <strong class="small">{{ comment.author.username }}</strong>
                {% if comment.author.activity.university %}
                    <span class="uni-badge uni-{{ comment.author.activity.university }}" style="font-size: 0.6rem; padding: 2px 6px;">
                        {% if comment.author.activity.university == 'ub' %}UB{% endif %}
                        {% if comment.author.activity.university == 'buan' %}BUAN{% endif %}
                        {% if comment.author.activity.university == 'botho' %}BOTHO{% endif %}
                        {% if comment.author.activity.university == 'limkokwing' %}LIMKO{% endif %}
                        {% if comment.author.activity.university == 'baisago' %}ISAGO{% endif %}
                        {% if comment.author.activity.university == 'biust' %}BIUST{% endif %}
                    </span>
                {% endif %}
                <span class="text-muted small">{{ comment.created_at|timesince }} ago</span>
                
                {% if user == comment.author %}
                    <button class="btn btn-link p-0 ms-auto text-danger delete-comment-btn" data-comment-id="{{ comment.id }}" style="font-size: 0.8rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                {% endif %}
            </div>
            
            <p class="mb-1 small">{{ comment.content }}</p>
            
            <!-- Comment actions -->
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-link p-0 comment-like-btn" data-comment-id="{{ comment.id }}" style="font-size: 0.8rem; color: #718096;">
                    <i class="fas fa-heart me-1" style="font-size: 0.7rem;"></i> Like <span class="comment-like-count">{{ comment.get_reaction_counts.like }}</span>
                </button>
                
                <!-- REPLY BUTTON - FIXED with proper onclick for testing -->
                <button class="btn btn-link p-0 reply-to-comment-btn" 
                        data-comment-id="{{ comment.id }}" 
                        data-post-id="{{ comment.post.id }}"
                        onclick="showReplyForm('{{ comment.id }}')"
                        style="font-size: 0.8rem; color: #718096;">
                    <i class="fas fa-reply me-1" style="font-size: 0.7rem;"></i> Reply
                </button>
                
                {% if comment.reply_count > 0 %}
                    <button class="btn btn-link p-0 view-replies-btn" data-comment-id="{{ comment.id }}" style="font-size: 0.8rem; color: #667eea;">
                        View {{ comment.reply_count }} repl{{ comment.reply_count|pluralize:"y,ies" }}
                    </button>
                {% endif %}
            </div>
            
            <!-- Reply form - FIXED with proper ID and styling -->
            <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px;">
                <div class="d-flex gap-2">
                    <input type="text" class="form-control form-control-sm reply-input" 
                           id="reply-input-{{ comment.id }}"
                           placeholder="Write a reply..." 
                           data-parent-id="{{ comment.id }}" 
                           data-post-id="{{ comment.post.id }}">
                    <button class="btn btn-primary btn-sm submit-reply-btn" 
                            data-parent-id="{{ comment.id }}"
                            onclick="submitReply('{{ comment.id }}', '{{ comment.post.id }}')">
                        Reply
                    </button>
                </div>
            </div>
            
            <!-- Container for replies -->
            <div class="replies-{{ comment.id }}" style="margin-top: 10px;">
                {% for reply in comment.replies.all %}
                    {% include 'posts/_comment.html' with comment=reply %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// DIRECT FUNCTIONS - NO EVENT LISTENER ISSUES
function showReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).style.display = 'block';
}

function submitReply(commentId, postId) {
    const input = document.getElementById(`reply-input-${commentId}`);
    const content = input.value.trim();
    const btn = event.target;
    
    if (!content) {
        alert('Please enter a reply');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    fetch(`/ajax/comment/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            content: content, 
            parent_id: commentId 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload to show the new reply
            location.reload();
        } else {
            alert(data.error || 'Error posting reply');
            btn.disabled = false;
            btn.innerHTML = 'Reply';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error');
        btn.disabled = false;
        btn.innerHTML = 'Reply';
    });
}
</script>